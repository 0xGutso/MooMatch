<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MooMatch ‚Äî Lamumu Memory Game üêÑ</title>
<meta name="description" content="Flip cards to match Lamumu-style cows. Beat the clock, save your score to the leaderboard, and share on X with #Lamumu @lamumudotxyz.">
<meta name="theme-color" content="#151515">
<style>
  :root{
  --bg:#0f1115;--panel:#161a23;--muted:#8a93a6;--text:#e6edf6;--accent:#89d185;--line:#232838;
  --good:#7ee787;--warn:#f2cc60;--bad:#ff7b72;
  --tile:120px; --gap:10px;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  background:radial-gradient(1100px 800px at 70% -20%, #1b2233 0%, var(--bg) 45%);
  color:var(--text);
  font:15px/1.5 ui-sans-serif,system-ui,-apple-system,Segoe UI,Inter,Arial;
  display:flex;align-items:center;justify-content:center;
  padding:18px;
  overflow:hidden; /* Patch B ekleme */
}
.app{
  width:100%;
  max-width:1200px;
  display:grid;
  grid-template-columns:320px 1fr;   /* sol panel 320px */
  gap:16px;
  align-items:start;                  /* kutularƒ± √ºstten hizala */
}
@media(max-width:980px){.app{grid-template-columns:1fr}}
.card{
  background:linear-gradient(180deg,rgba(255,255,255,.03),transparent 30%),var(--panel);
  border:1px solid var(--line);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.35)
}
.side{
  padding:16px;
  max-height:calc(100vh - 36px);
  overflow-y:auto;
  overflow-x:hidden;
}
h1{margin:0 0 6px;font-size:22px}
.muted{color:var(--muted);margin:0 0 14px}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin:10px 0 6px}
select,button,input{
  appearance:none;border:1px solid var(--line);background:#1f2533;color:var(--text);
  padding:10px 12px;border-radius:10px
}
button{cursor:pointer}
button:hover{background:#262d40}
input{min-width:170px}
.stats{display:flex;gap:12px;flex-wrap:wrap;margin:10px 0 4px}
.stat{padding:6px 10px;border:1px dashed var(--line);border-radius:10px;color:var(--muted);font-size:13px}
.grid{
  display:flex;
  align-items:center;
  justify-content:center;
  padding:14px;
  height:calc(100vh - 36px);   /* sabit y√ºkseklik */
  margin:0;                    /* ‚ùå √∂nceki margin:150px 0 satƒ±rƒ±nƒ± KALDIR */
  overflow:hidden;
}
.sidebar {
  margin-top: 30px;  /* istediƒüin kadar oynat, √∂rn. 20-40px */
}
/* Saƒü tarafƒ± daha kompakt yap */
.board-container {
  max-height: 80vh;   /* ekranƒ±n %80‚Äôi kadar */
  margin-top: 15px;   /* √ºstten bo≈üluk */
  margin-bottom: 15px;/* alttan bo≈üluk */
  display: flex;
  align-items: center;   /* dikey ortala */
  justify-content: center; /* yatay ortala */
}
.board{
  display:grid;
  gap:var(--gap,10px);
  grid-template-columns:repeat(4,var(--tile)); /* Patch B ekleme */
}
.tile{
  position:relative;
  width:var(--tile);height:var(--tile);aspect-ratio:auto; /* Patch B ekleme */
  perspective:1000px
}
.inner{width:100%;height:100%;position:absolute;transform-style:preserve-3d;transition:transform .45s cubic-bezier(.2,.8,.2,1)}
.tile.flipped .inner{transform:rotateY(180deg)}
.face{position:absolute;inset:0;border-radius:12px;backface-visibility:hidden;border:1px solid var(--line);overflow:hidden}
.front{background:#0e1426;display:flex;align-items:center;justify-content:center}
.back{transform:rotateY(180deg);background:#0b0f19}
.front .moo{font-weight:700;color:#a6d1ff}
.badge{display:inline-block;padding:3px 8px;border:1px dashed var(--line);border-radius:999px;color:var(--muted);font-size:12px}
.footer{padding:10px 14px;border-top:1px dashed var(--line);color:var(--muted);font-size:12px}
.pill{padding:8px 10px;border-radius:999px;border:1px solid var(--line)}
.ok{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}
.lb{margin-top:10px;max-height:280px;overflow:auto;border:1px dashed var(--line);border-radius:12px;padding:10px}
.lb h3{margin:0 0 8px;font-size:14px;color:var(--muted)}
.lb .row{display:flex;justify-content:space-between;padding:6px 4px;border-bottom:1px solid rgba(255,255,255,.05)}
.lb .row:last-child{border-bottom:0}
</style>
</head>
<body>
<div class="app">
  <div class="card side">
    <h1>MooMatch <span class="badge">Lamumu</span></h1>
    <p class="muted">Flip cards and match the Lamumu cows. Fast, cute, and a little addictive.</p>

    <div class="controls">
      <label class="badge">Difficulty</label>
      <select id="mode">
        <option value="4x4">Easy (4√ó4)</option>
        <option value="5x4">Medium (5√ó4)</option>
        <option value="6x4">Hard (6√ó4)</option>
      </select>
      <label class="badge">Theme</label>
      <select id="theme">
        <option value="meadow">Meadow</option>
        <option value="cabin">Cabin</option>
        <option value="jungle">Jungle</option>
        <option value="ocean">Ocean</option>
        <option value="arctic">Arctic</option>
        <option value="dark" selected>Dark</option>
      </select>
    </div>

    <div class="controls">
      <input id="username" placeholder="Username for leaderboard" />
      <button id="saveName">Save name</button>
      <button id="newGame">üîÅ New game</button>
      <button id="share">üí¨ Share</button>
    </div>

    <div class="stats">
      <div class="stat">‚è±Ô∏è Time: <span id="time">00:00</span></div>
      <div class="stat">üß† Moves: <span id="moves">0</span></div>
      <div class="stat">‚úÖ Matches: <span id="matches">0</span></div>
      <div class="stat">üîë Seed: <span id="seedLabel">‚Äî</span></div>
    </div>

    <p class="muted" id="status"><span class="pill">Good luck! üêÑ</span></p>

    <div class="lb" id="leaderboard">
      <h3>Leaderboard (Top 20)</h3>
      <div class="rows"></div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button id="refreshLb">Refresh</button>
        <span class="badge">Sorted by score (desc)</span>
      </div>
    </div>

    <div class="footer">Tip: After you win, post your PNG + seed on X with <strong>#Lamumu</strong> and mention <strong>@lamumudotxyz</strong>.</div>
  </div>

  <div class="card grid">
    <div id="board" class="board"></div>
  </div>
</div>

<script>
/* ======================= SUPABASE CONFIG ======================= */
/* üëâ Replace these two values with your project's values (Settings ‚Üí API) */
const SUPABASE_URL = "https://tvucepkfjfkcatybwbtj.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InR2dWNlcGtmamZrY2F0eWJ3YnRqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ4NDMyMjIsImV4cCI6MjA3MDQxOTIyMn0.e5lAL02f4CLzZp2WblvWG0el5RKj8L4JukohG_wXTCc";
/* =============================================================== */

async function saveScoreRow(row){
  try{
    const res = await fetch(`${SUPABASE_URL}/rest/v1/scores`, {
      method:"POST",
      headers:{
        "apikey": SUPABASE_KEY,
        "Authorization": `Bearer ${SUPABASE_KEY}`,
        "Content-Type": "application/json",
        "Prefer": "return=representation"
      },
      body: JSON.stringify(row)
    });
    if(!res.ok){ console.error("Save error:", await res.text()); return null; }
    return res.json();
  }catch(err){ console.error(err); return null; }
}

async function fetchTop(limit=20){
  const url = `${SUPABASE_URL}/rest/v1/scores?select=*&order=score.desc&order=created_at.asc&limit=${limit}`;
  const res = await fetch(url, { headers:{ "apikey":SUPABASE_KEY, "Authorization":`Bearer ${SUPABASE_KEY}` }});
  return res.ok ? res.json() : [];
}
</script>

<script>
/* ---------- helpers ---------- */
const $ = s => document.querySelector(s);
const pad = n => String(n).padStart(2,'0');
const rng = (seed)=>{let t=seed>>>0;return ()=>{t+=0x6D2B79F5;let r=Math.imul(t^t>>>15,1|t);r^=r+Math.imul(r^r>>>7,61|r);return((r^r>>>14)>>>0)/4294967296;};};
function fmtTime(sec){const m=Math.floor(sec/60), s=sec%60; return `${pad(m)}:${pad(s)}`;}
function shuffle(a, R){for(let i=a.length-1;i>0;i--){const j=Math.floor(R()* (i+1)); [a[i],a[j]]=[a[j],a[i]];} return a;}
function byMode(mode){return mode==='4x4'?[4,4]:mode==='5x4'?[5,4]:[6,4];}

/* ---------- Lamumu mini art (cards) ---------- */
const size=256, cx=size/2, cy=size/2;
const P = {
  white:{base:'#fff7ef', spot:'#1b1b1b', nose:'#e7b6a0', horn:'#f0e2c1'},
  cocoa:{base:'#7b4b2e', spot:'#2c1b12', nose:'#d1a489', horn:'#e2d3ad'},
  night:{base:'#232631', spot:'#6e7ea6', nose:'#a8b3d6', horn:'#e2d3ad'},
  nebula:{base:'#efeaff', spot:'#7a5cff', nose:'#ff9bd7', horn:'#f0e2c1'}
};
const bodies = [
  {name:'Lamumu', pal:P.white, patch:true, spots:3},
  {name:'Holstein', pal:P.white, patch:false, spots:6},
  {name:'Cocoa', pal:P.cocoa, patch:false, spots:5},
  {name:'Night', pal:P.night, patch:false, spots:5},
  {name:'Nebula', pal:P.nebula, patch:false, spots:4},
];
const eyesList=['normal','sleepy','sunglasses','laser','hearts'];
const mouths=['smile','tongue','open','vibe','whistle'];
const accs=['none','cap','ring','bell','astro'];

function drawCow(seed, v = {}){
  const R = rng(seed);

  // Eƒüer setup'tan varyant geldiyse onu kullan; yoksa rastgele √ºret
  const bodyIdx   = (v.bodyIdx ?? Math.floor(R()*bodies.length)) | 0;
  const eye       = v.eye   ?? eyesList[Math.floor(R()*eyesList.length)];
  const mouth     = v.mouth ?? mouths[Math.floor(R()*mouths.length)];
  const acc       = v.acc   ?? accs[Math.floor(R()*accs.length)];
  const hue       = (v.hue  ?? Math.floor(R()*360)) | 0;
  const patchSide = R() < 0.5 ? -1 : +1;
  const headTilt  = (R()-.5) * 0.18;
  const blushOn   = R() < 0.65;
  const frameStyle= Math.floor(R()*4);
  const ringOn    = R() < 0.35;

  const body = bodies[bodyIdx];

  const c = document.createElement('canvas'); c.width=size; c.height=size;
  const ctx=c.getContext('2d');

  // Arka plan
  const bg = ctx.createLinearGradient(0,0,size,size);
  bg.addColorStop(0,'#0a0e1a'); bg.addColorStop(1,'#121a2c');
  ctx.fillStyle=bg; ctx.fillRect(0,0,size,size);

  // Hafif filtre: her √ßifte farklƒ± renk tonu
  ctx.save();
  ctx.filter = `hue-rotate(${hue}deg) saturate(1.05)`;

  // √áer√ßeve
  if(frameStyle===1){ ctx.strokeStyle='rgba(180,200,255,.25)'; ctx.lineWidth=10;
    ctx.beginPath(); ctx.arc(cx,cy, size*0.46, 0, Math.PI*2); ctx.stroke();
  } else if(frameStyle===2){ ctx.strokeStyle='rgba(120,200,255,.22)'; ctx.lineWidth=8;
    ctx.beginPath(); ctx.arc(cx,cy, size*0.45, 0, Math.PI*2); ctx.stroke();
    ctx.strokeStyle='rgba(255,180,220,.18)'; ctx.lineWidth=5;
    ctx.beginPath(); ctx.arc(cx,cy, size*0.40, 0, Math.PI*2); ctx.stroke();
  } else if(frameStyle===3){
    ctx.fillStyle='rgba(255,255,255,.04)';
    for(const [x,y] of [[60,60],[size-60,60],[60,size-60],[size-60,size-60]]){
      ctx.beginPath(); ctx.arc(x,y,20,0,Math.PI*2); ctx.fill();
    }
  }

  const stroke=8;
  function outline(f,w=stroke){ctx.save();ctx.lineWidth=w;ctx.strokeStyle='#111';ctx.lineJoin='round';ctx.lineCap='round';f();ctx.stroke();ctx.restore();}

  // Sahneyi d√∂nd√ºr (kafa eƒüimi)
  ctx.save(); ctx.translate(cx,cy); ctx.rotate(headTilt); ctx.translate(-cx,-cy);

  // Ba≈ü
  ctx.fillStyle=body.pal.base; const head=()=>{ctx.beginPath();ctx.ellipse(cx,cy+10,110,94,0,0,Math.PI*2)}; outline(head); head(); ctx.fill();
  // Kulaklar
  const le=()=>{ctx.beginPath();ctx.ellipse(cx-100,cy-40,28,42,-.2,0,Math.PI*2)}; outline(le); le(); ctx.fill();
  const re=()=>{ctx.beginPath();ctx.ellipse(cx+100,cy-40,28,42,.2,0,Math.PI*2)}; outline(re); re(); ctx.fill();
  // Boynuz
  ctx.fillStyle=body.pal.horn;
  const lh=()=>{ctx.beginPath();ctx.moveTo(cx-62,cy-68);ctx.quadraticCurveTo(cx-82,cy-110,cx-40,cy-96);ctx.quadraticCurveTo(cx-36,cy-82,cx-62,cy-68)}; outline(lh); lh(); ctx.fill();
  const rh=()=>{ctx.beginPath();ctx.moveTo(cx+62,cy-68);ctx.quadraticCurveTo(cx+82,cy-110,cx+40,cy-96);ctx.quadraticCurveTo(cx+36,cy-82,cx+62,cy-68)}; outline(rh); rh(); ctx.fill();

  // Y√ºz patch (saƒü/sol)
  if(body.patch){
    ctx.fillStyle='#9aa0a6';
    const p=()=>{ctx.beginPath();ctx.ellipse(cx+patchSide*42,cy-10,52,58,-.2*patchSide,0,Math.PI*2)};
    outline(p,6); p(); ctx.fill();
  }

  // --- Benekler: √ßakƒ±≈ümasƒ±z yerle≈üim ---
  const RS = rng(v.spotSeed ?? Math.floor(R()*1e9));
  const spots = [];
  const n = 3 + Math.floor(RS()*4); // 3..6 adet
  for(let i=0;i<n;i++){
    let tries=0, x, y;
    // minimum mesafe: 22px
    do{
      x = cx + (RS()*160 - 80);
      y = cy + (RS()*120 - 60);
      tries++;
    }while(spots.some(s => Math.hypot(s.x-x, s.y-y) < 22) && tries<30);
    spots.push({
      x,y, rx:18+RS()*38, ry:14+RS()*34, rot:(RS()-.5)*1.0
    });
  }
  ctx.fillStyle=body.pal.spot;
  for(const s of spots){
    ctx.save(); ctx.translate(s.x,s.y); ctx.rotate(s.rot);
    const sp=()=>{ctx.beginPath();ctx.ellipse(0,0,s.rx,s.ry,0,0,Math.PI*2)}; outline(sp,4); sp(); ctx.globalAlpha=.92; ctx.fill(); ctx.restore();
  }

  // Burun + yanak
  ctx.globalAlpha=1; ctx.fillStyle=body.pal.nose;
  const mz=()=>{ctx.beginPath();ctx.ellipse(cx,cy+48,76,42,0,0,Math.PI*2)}; outline(mz,6); mz(); ctx.fill();
  if(blushOn){
    ctx.fillStyle='rgba(255,120,150,.28)';
    ctx.beginPath(); ctx.ellipse(cx-52, cy+44, 18,12, 0,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.ellipse(cx+52, cy+44, 18,12, 0,0,Math.PI*2); ctx.fill();
  }
  ctx.fillStyle='rgba(0,0,0,.25)';
  const n1=()=>{ctx.beginPath();ctx.ellipse(cx-18,cy+48,7,12,0,0,Math.PI*2)}; outline(n1,4); n1(); ctx.fill();
  const n2=()=>{ctx.beginPath();ctx.ellipse(cx+18,cy+48,7,12,0,0,Math.PI*2)}; outline(n2,4); n2(); ctx.fill();

  // G√∂zler
  if(eye==='normal'){ ctx.fillStyle='#222';
    const s=(x,y)=>{const f=()=>{ctx.beginPath();ctx.ellipse(x,y,22,16,0,0,Math.PI*2)}; outline(f,6); f(); ctx.fill(); ctx.fillStyle='#fff'; ctx.beginPath(); ctx.ellipse(x,y,16,12,0,0,Math.PI*2); ctx.fill();};
    s(cx-40,cy-6); s(cx+40,cy-6); ctx.fillStyle='#111';
    ctx.beginPath(); ctx.arc(cx-34,cy-6,5,0,Math.PI*2); ctx.fill();
    ctx.beginPath(); ctx.arc(cx+46,cy-4,5,0,Math.PI*2); ctx.fill();
  } else if(eye==='sleepy'){ ctx.strokeStyle='#111'; ctx.lineWidth=8; ctx.lineCap='round';
    ctx.beginPath(); ctx.moveTo(cx-60,cy); ctx.quadraticCurveTo(cx-44,cy-14,cx-28,cy); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(cx+28,cy); ctx.quadraticCurveTo(cx+44,cy-14,cx+60,cy); ctx.stroke();
  } else if(eye==='sunglasses'){ const lens=(x)=>{ctx.fillStyle='#0e0e0e'; const f=()=>{ctx.beginPath();ctx.ellipse(x,cy,24,18,0,0,Math.PI*2)}; outline(f,8); f(); ctx.fill();}; lens(cx-40); lens(cx+40); ctx.strokeStyle='#333'; ctx.lineWidth=8; ctx.beginPath(); ctx.moveTo(cx-20,cy); ctx.lineTo(cx+20,cy); ctx.stroke(); }
  else if(eye==='laser'){ ctx.fillStyle='#fff'; [-40,40].forEach(dx=>{const f=()=>{ctx.beginPath();ctx.ellipse(cx+dx,cy,18,14,0,0,Math.PI*2)}; outline(f,6); f(); ctx.fill();}); ctx.fillStyle='#ff0040'; ctx.beginPath(); ctx.arc(cx-40,cy,4,0,Math.PI*2); ctx.fill(); ctx.beginPath(); ctx.arc(cx+40,cy,4,0,Math.PI*2); ctx.fill(); ctx.fillStyle='rgba(255,0,64,.55)'; ctx.fillRect(0, cy+2, size, 4);}
  else { // hearts
    ctx.fillStyle='#ff4d6d'; const heart=(x,y)=>{ctx.save();ctx.translate(x,y); const f=()=>{ctx.beginPath();ctx.moveTo(0,-8);ctx.bezierCurveTo(8,-18,18,-4,0,14);ctx.bezierCurveTo(-18,-4,-8,-18,0,-8)}; outline(f,6); f(); ctx.fill(); ctx.restore();};
    heart(cx-40,cy); heart(cx+40,cy);
  }

  // Aƒüƒ±z
  ctx.strokeStyle='#3a1a10'; ctx.lineWidth=8; ctx.lineCap='round';
  if(mouth==='smile'){ ctx.beginPath(); ctx.arc(cx, cy+40, 32, 0, Math.PI); ctx.stroke();}
  if(mouth==='tongue'){ ctx.beginPath(); ctx.moveTo(cx-28,cy+42); ctx.quadraticCurveTo(cx,cy+62,cx+28,cy+42); ctx.stroke(); ctx.fillStyle='#ff6b9a'; ctx.beginPath(); ctx.ellipse(cx, cy+54, 12, 9, 0, 0, Math.PI*2); ctx.fill();}
  if(mouth==='open'){ const f=()=>{ctx.beginPath(); ctx.ellipse(cx, cy+50, 18, 14, 0, 0, Math.PI*2)}; outline(f,6); f(); ctx.fillStyle='#2a1710'; ctx.fill();}
  if(mouth==='vibe'){ ctx.beginPath(); ctx.moveTo(cx-30,cy+44); ctx.lineTo(cx-6,cy+52); ctx.lineTo(cx+12,cy+40); ctx.lineTo(cx+30,cy+48); ctx.stroke();}
  if(mouth==='whistle'){ ctx.beginPath(); ctx.arc(cx, cy+48, 12, Math.PI*.1, Math.PI*.9); ctx.stroke();}

  // Aksesuar + kulak halkasƒ±
  if(acc==='cap'){ const f=()=>{ctx.beginPath(); ctx.ellipse(cx, cy-54, 70, 30, .02, 0, Math.PI*2)}; outline(f,6); f(); ctx.fillStyle='#2b6cf0'; ctx.fill(); const br=()=>{ctx.beginPath(); ctx.ellipse(cx+30, cy-38, 54, 18, .02, 0, Math.PI*2)}; outline(br,6); br(); ctx.fillStyle='#244db3'; ctx.fill();}
  if(acc==='ring' || ringOn){ ctx.strokeStyle='#ffd400'; ctx.lineWidth=8; ctx.beginPath(); ctx.arc(cx-100, cy-10, 14, 0, Math.PI*2); ctx.stroke(); }
  if(acc==='bell'){ const f=()=>{ctx.beginPath(); ctx.ellipse(cx, cy+86, 18, 14, 0, 0, Math.PI*2)}; outline(f,6); f(); ctx.fillStyle='#ffcf33'; ctx.fill(); ctx.fillStyle='#c08a00'; ctx.beginPath(); ctx.arc(cx, cy+94, 6, 0, Math.PI*2); ctx.fill();}
  if(acc==='astro'){ ctx.strokeStyle='rgba(200,230,255,.7)'; ctx.lineWidth=8; ctx.beginPath(); ctx.ellipse(cx, cy-6, 130, 120, 0, 0, Math.PI*2); ctx.stroke();}

  ctx.restore(); // head tilt
  ctx.restore(); // filter

  // Alt ≈üerit
  ctx.fillStyle='rgba(0,0,0,.35)'; ctx.fillRect(0,size-40,size,40);
  ctx.fillStyle='rgba(255,255,255,.9)'; ctx.font='16px ui-sans-serif'; ctx.fillText('Lamumu', 12, size-12);

  return c.toDataURL('image/png');
}



/* ---------- game state ---------- */
const boardEl = $('#board');
let first=null, lock=false, matches=0, moves=0, elapsed=0, timer=null, seed=0, mode='4x4';

function byTheme(th){
  const parent = boardEl.parentElement;
  parent.style.transition='background .3s ease';
  parent.style.background =
    th==='dark'   ? '#0d1220' :
    th==='meadow' ? 'linear-gradient(#bfe8ff,#dff5ff)' :
    th==='cabin'  ? '#332115' :
    th==='jungle' ? '#132219' :
    th==='ocean'  ? '#147ad6' :
                    '#cfe9ff';
}

function setup(){
  // 1) Mod & tema
  mode = $('#mode').value;
  byTheme($('#theme').value);

  // 2) Grid kolonlarƒ± (tile tabanlƒ±)
  const [cols, rows] = byMode(mode);
  boardEl.style.gridTemplateColumns = `repeat(${cols}, var(--tile))`;

  // 3) Yeni seed ve etiket
  seed = Math.floor(Math.random()*1e9);
  $('#seedLabel').textContent = String(seed).slice(-6);

  // 4) Kart kimlikleri (her √ßift i√ßin 1 id)
  const total = cols * rows;
  const R = rng(seed);
  const ids = [];
  for (let i = 0; i < total/2; i++) ids.push(Math.floor(R()*1e9));

  // 5) √áiftleri kar ve diziye iki kez koy
  const cards = shuffle([...ids, ...ids], R);

  // 6) Her √áƒ∞FT i√ßin benzersiz varyant (renk/g√∂vde/g√∂z/aƒüƒ±z/aksesuar/benek)
  const pairCount = total/2;
  const hues = shuffle([...Array(pairCount)].map((_, i) => (i*47) % 360), R); // geni≈ü aralƒ±klƒ± hue
  const bodyOrder = shuffle([...Array(bodies.length).keys()], R);

  const pairVariant = {};
  for (let i = 0; i < pairCount; i++){
    pairVariant[ids[i]] = {
      bodyIdx: bodyOrder[i % bodies.length],
      hue: hues[i],
      spotSeed: Math.floor(R()*1e9),
      eye:   eyesList[i % eyesList.length],
      mouth: mouths[(i*2) % mouths.length],
      acc:   accs[(i*3) % accs.length],
    };
  }

  // 7) Board'u kur
  boardEl.innerHTML = '';
  for (const id of cards){
    const d = document.createElement('div'); d.className = 'tile'; d.dataset.id = id;
    const inner = document.createElement('div'); inner.className = 'inner';
    const front = document.createElement('div'); front.className = 'face front';
    front.innerHTML = `<div class="moo">LAMUMU</div>`;
    const back = document.createElement('div'); back.className = 'face back';

    const img = new Image();
    img.src = drawCow(id, pairVariant[id]);   // üëà √ßift varyantƒ± uygulanƒ±yor
    img.style.width = '100%'; img.style.height = '100%'; img.draggable = false;

    back.appendChild(img);
    inner.appendChild(front); inner.appendChild(back);
    d.appendChild(inner);
    d.addEventListener('click', onFlip);
    boardEl.appendChild(d);
  }

  // 8) Saya√ßlar & durum
  matches = 0; moves = 0; elapsed = 0; updateStats();
  $('#status').innerHTML = `<span class="pill">Good luck! üêÑ</span>`;
  if(timer) clearInterval(timer);
  timer = null;

  // 9) Ekrana sƒ±ƒüdƒ±r
  fitBoard();
}


function fitBoard(){
  const [cols, rows] = byMode(mode);
  const gridWrap = document.querySelector('.grid');
  if(!gridWrap) return;

  const availW = gridWrap.clientWidth  - 28;
  const availH = gridWrap.clientHeight - 28;

  const gapX = 10 * (cols - 1);
  const gapY = 10 * (rows - 1);

  let tile = Math.floor(Math.min(
    (availW - gapX) / cols,
    (availH - gapY) / rows
  ));

  tile = Math.max(72, Math.min(tile, 220));
  document.documentElement.style.setProperty('--tile', tile + 'px');
  boardEl.style.gridTemplateColumns = `repeat(${cols}, var(--tile))`;
}

function onFlip(e){
  const tile = e.currentTarget;

  // Ge√ßersiz tƒ±klamalarƒ± engelle
  if (lock || tile.classList.contains('flipped')) return;

  // ‚è±Ô∏è ƒ∞lk ge√ßerli tƒ±klamada timer'ƒ± ba≈ülat
  if (!timer) {
    timer = setInterval(() => {
      elapsed++;
      $('#time').textContent = fmtTime(elapsed);
    }, 1000);
  }

  // Flip mantƒ±ƒüƒ±
  tile.classList.add('flipped');
  if (!first) { first = tile; return; }

  moves++; updateStats();

  const match = first.dataset.id === tile.dataset.id;
  if (match) {
    matches++; first = null; checkWin();
  } else {
    lock = true;
    setTimeout(() => {
      first.classList.remove('flipped');
      tile.classList.remove('flipped');
      first = null; lock = false;
    }, 650);
  }
}

function updateStats(){
  $('#moves').textContent = moves;
  $('#matches').textContent = matches;
  $('#time').textContent = fmtTime(elapsed);
}

function checkWin(){
  const totalPairs = boardEl.children.length/2;
  if(matches === totalPairs){
    clearInterval(timer);
    const score = Math.max(1, Math.round(10000/(elapsed+moves)));
    const tone = elapsed<=60 ? 'ok' : elapsed<=120 ? 'warn' : 'bad';
    $('#status').innerHTML = `<span class="pill ${tone}">Finished in ${fmtTime(elapsed)} with ${moves} moves ‚Ä¢ Score ${score}</span>`;
    // Save to Supabase
    const username = ($('#username').value || 'anon').slice(0,20);
    saveScoreRow({ username, score, moves, time: elapsed, created_at:new Date().toISOString() }).then(renderLeaderboard);
    // Offer share
    setTimeout(()=>offerShare(score), 300);
  }
}

function offerShare(score){
  const btn = document.createElement('button');
  btn.textContent = 'Share on X';
  btn.onclick = ()=>share(score);
  btn.style.marginLeft = '8px';
  $('#status').appendChild(btn);
}

function share(score){
  const username = ($('#username').value || 'anon').slice(0,20);

  const text = [
    'I beat MooMatch! üêÑ',
    `User: ${username}`,
    `Mode: ${mode}`,
    `Time: ${fmtTime(elapsed)} ‚Ä¢ Moves: ${moves} ‚Ä¢ Score: ${score}`,
    `Seed: ${seed} https://moo-match.vercel.app/`,
    '',
    'gMoo üêÆ',
    '',
    '#MooMatch @lamumudotxyz'
  ].join('\n');

  const intent = 'https://twitter.com/intent/tweet?text=' + encodeURIComponent(text);
  window.open(intent, '_blank');
}

/* ---------- leaderboard ---------- */
async function renderLeaderboard(){
  const wrap = document.querySelector('#leaderboard .rows');
  wrap.innerHTML = 'Loading‚Ä¶';
  const rows = await fetchTop(20);
  if(!rows.length){ wrap.innerHTML = '<span class="muted">No scores yet.</span>'; return; }
  wrap.innerHTML = rows.map((r,i)=>(
    `<div class="row"><span>${i+1}. <strong>${escapeHtml(r.username||'anon')}</strong></span>
      <span>${r.score} pts ¬∑ ${r.time}s ¬∑ ${r.moves} moves</span></div>`
  )).join('');
}
function escapeHtml(s){return (s||'').replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;' }[m]));}

/* ---------- actions ---------- */
$('#newGame').addEventListener('click', setup);
$('#mode').addEventListener('change', setup);
$('#theme').addEventListener('change', ()=>{byTheme($('#theme').value); setup();});
$('#share').addEventListener('click', ()=>{
  if (!elapsed && !moves) { alert('Finish a game first!'); return; }
  share(0);
});
$('#refreshLb').addEventListener('click', renderLeaderboard);
$('#saveName').addEventListener('click', ()=>{
  const v = ($('#username').value||'').trim().slice(0,20) || 'anon';
  localStorage.setItem('lamu_user', v);
});

document.getElementById('username').addEventListener('input', e=>{
  localStorage.setItem('lamu_user', (e.target.value||'').slice(0,20));
});

/* ---------- init ---------- */
(function init(){
  const savedName = localStorage.getItem('lamu_user');
  if(savedName) $('#username').value = savedName;
  else $('#username').value = 'anon';
  setup();
  fitBoard();
  window.addEventListener('resize', fitBoard);
  renderLeaderboard();
})();
</script>
</body>
</html>
